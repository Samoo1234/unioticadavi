# Guia de Correção - Página Datas Disponíveis

## Problema Identificado

A página "Datas Disponíveis" está apresentando erros HTTP 400 devido a problemas na estrutura da tabela `datas_disponiveis`. Os principais problemas são:

1. **Erro de UUID**: "invalid input syntax for type uuid: "0"" - causado por valores inválidos na consulta
2. **Estrutura da tabela**: A tabela foi migrada de `cidade_id` para `filial_id`, mas pode estar faltando a coluna `medico_id`
3. **Consultas com erro**: Problemas na busca e salvamento de datas disponíveis

## Soluções Implementadas

### 1. Correção do Código TypeScript

✅ **Arquivo corrigido**: `src/pages/DatasDisponiveis.tsx`

**Mudanças realizadas**:
- Corrigido o problema com `editingId` na consulta de verificação de duplicatas
- Melhorado o tratamento de erros na busca de médicos
- Adicionado try-catch para evitar falhas na consulta de médicos

### 2. Scripts SQL de Correção

#### Script de Verificação
**Arquivo**: `check_datas_disponiveis_structure.sql`
- Verifica a estrutura atual da tabela
- Identifica problemas de constraints e índices
- Mostra dados existentes

#### Script de Correção Completa
**Arquivo**: `fix_datas_disponiveis_complete.sql`
- Adiciona coluna `medico_id` se não existir
- Adiciona coluna `filial_id` se não existir
- Remove coluna `cidade_id` (migração completa)
- Cria foreign keys e índices necessários
- Testa consultas básicas

## Como Executar as Correções

### Passo 1: Executar o Script de Verificação

```sql
-- Execute no Supabase SQL Editor
-- Arquivo: check_datas_disponiveis_structure.sql
```

Este script mostrará:
- Se a tabela existe
- Estrutura atual das colunas
- Constraints e foreign keys
- Dados existentes

### Passo 2: Executar o Script de Correção

```sql
-- Execute no Supabase SQL Editor
-- Arquivo: fix_datas_disponiveis_complete.sql
```

Este script irá:
- ✅ Adicionar coluna `medico_id` se necessário
- ✅ Adicionar coluna `filial_id` se necessário
- ✅ Remover coluna `cidade_id` (migração)
- ✅ Criar foreign keys e índices
- ✅ Testar consultas

### Passo 3: Verificar a Aplicação

Após executar os scripts:
1. Recarregue a página "Datas Disponíveis"
2. Verifique se os erros no console desapareceram
3. Teste cadastrar uma nova data disponível
4. Teste editar uma data existente

## Estrutura Esperada da Tabela

Após a correção, a tabela `datas_disponiveis` deve ter:

```sql
CREATE TABLE datas_disponiveis (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  filial_id BIGINT NOT NULL REFERENCES filiais(id),
  medico_id BIGINT NOT NULL REFERENCES medicos(id),
  data DATE NOT NULL,
  horarios_disponiveis JSONB NOT NULL DEFAULT '[]',
  ativa BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Índices Esperados

- `idx_datas_disponiveis_filial_id`
- `idx_datas_disponiveis_medico_id`
- `idx_datas_disponiveis_data`
- `idx_datas_disponiveis_ativa`

## Constraints Esperadas

- `fk_datas_disponiveis_filial` (FOREIGN KEY)
- `fk_datas_disponiveis_medico` (FOREIGN KEY)

## Troubleshooting

### Se ainda houver erros após a correção:

1. **Verificar console do navegador**:
   - Abra as ferramentas de desenvolvedor (F12)
   - Vá para a aba Console
   - Identifique novos erros

2. **Verificar estrutura da tabela**:
   ```sql
   SELECT column_name, data_type, is_nullable 
   FROM information_schema.columns 
   WHERE table_name = 'datas_disponiveis'
   ORDER BY ordinal_position;
   ```

3. **Verificar dados existentes**:
   ```sql
   SELECT COUNT(*) as total,
          COUNT(CASE WHEN medico_id IS NOT NULL THEN 1 END) as com_medico,
          COUNT(CASE WHEN filial_id IS NOT NULL THEN 1 END) as com_filial
   FROM datas_disponiveis;
   ```

### Problemas Comuns

1. **"Column does not exist"**: Execute o script de correção
2. **"Foreign key violation"**: Verifique se existem médicos e filiais cadastrados
3. **"Invalid input syntax"**: Verifique se os dados estão sendo passados corretamente

## Contato

Se os problemas persistirem após executar todas as correções, verifique:
- Logs do Supabase
- Console do navegador
- Estrutura atual da tabela

---

**Status**: ✅ Correções implementadas
**Última atualização**: $(date) 