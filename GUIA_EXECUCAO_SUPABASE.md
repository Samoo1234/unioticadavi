# Guia de Execução da Migração no Supabase

## Pré-requisitos
- Acesso ao painel do Supabase
- Projeto configurado
- Backup do banco atual (recomendado)

## Passos para Execução

### 1. Acessar o SQL Editor
1. Entre no painel do Supabase
2. Vá para **SQL Editor** no menu lateral
3. Clique em **New Query**

### 2. Executar a Migração

#### Opção A: Executar o Script Completo
1. Copie todo o conteúdo do arquivo `migration_supabase.sql`
2. Cole no SQL Editor
3. Clique em **Run** (Ctrl+Enter)

#### Opção B: Executar em Partes (Recomendado)
Para melhor controle, execute em seções:

**Parte 1: Criação da tabela fornecedores**
```sql
-- Criar tabela fornecedores
CREATE TABLE IF NOT EXISTS fornecedores (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome VARCHAR(255) NOT NULL,
  cnpj VARCHAR(18),
  telefone VARCHAR(20),
  email VARCHAR(255),
  endereco TEXT,
  contato_principal VARCHAR(255),
  observacoes TEXT,
  filial_id BIGINT REFERENCES filiais(id),
  ativo BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Parte 2: Migração de Referências Cidades → Filiais**
```sql
-- Criar filiais para cidades que não existem como filiais
INSERT INTO filiais (nome, endereco, ativa, created_at, updated_at)
SELECT 
  c.nome,
  COALESCE('Endereço da ' || c.nome, 'Endereço não informado'),
  c.ativa,
  c.created_at,
  c.updated_at
FROM cidades c
WHERE NOT EXISTS (
  SELECT 1 FROM filiais f 
  WHERE LOWER(f.nome) = LOWER(c.nome)
);

-- Adicionar coluna filial_id nas tabelas que usam cidade_id
ALTER TABLE clientes ADD COLUMN IF NOT EXISTS filial_id BIGINT REFERENCES filiais(id);
ALTER TABLE agendamentos ADD COLUMN IF NOT EXISTS filial_id BIGINT REFERENCES filiais(id);
ALTER TABLE datas_disponiveis ADD COLUMN IF NOT EXISTS filial_id BIGINT REFERENCES filiais(id);
ALTER TABLE configuracoes_horarios ADD COLUMN IF NOT EXISTS filial_id BIGINT REFERENCES filiais(id);
```

**Parte 3: Atualizar referências**
```sql
-- Atualizar clientes: migrar cidade_id para filial_id
UPDATE clientes 
SET filial_id = (
  SELECT f.id 
  FROM filiais f 
  JOIN cidades c ON LOWER(f.nome) = LOWER(c.nome)
  WHERE c.id = clientes.cidade_id
)
WHERE cidade_id IS NOT NULL;

-- Atualizar agendamentos: migrar cidade_id para filial_id
UPDATE agendamentos 
SET filial_id = (
  SELECT f.id 
  FROM filiais f 
  JOIN cidades c ON LOWER(f.nome) = LOWER(c.nome)
  WHERE c.id = agendamentos.cidade_id
)
WHERE cidade_id IS NOT NULL;

-- Atualizar datas_disponiveis: migrar cidade_id para filial_id
UPDATE datas_disponiveis 
SET filial_id = (
  SELECT f.id 
  FROM filiais f 
  JOIN cidades c ON LOWER(f.nome) = LOWER(c.nome)
  WHERE c.id = datas_disponiveis.cidade_id
)
WHERE cidade_id IS NOT NULL;

-- Atualizar configuracoes_horarios: migrar cidade_id para filial_id
UPDATE configuracoes_horarios 
SET filial_id = (
  SELECT f.id 
  FROM filiais f 
  JOIN cidades c ON LOWER(f.nome) = LOWER(c.nome)
  WHERE c.id = configuracoes_horarios.cidade_id
)
WHERE cidade_id IS NOT NULL;

-- Remover colunas cidade_id após migração (opcional)
-- ALTER TABLE clientes DROP COLUMN IF EXISTS cidade_id;
-- ALTER TABLE agendamentos DROP COLUMN IF EXISTS cidade_id;
-- ALTER TABLE datas_disponiveis DROP COLUMN IF EXISTS cidade_id;
-- ALTER TABLE configuracoes_horarios DROP COLUMN IF EXISTS cidade_id;
```

**Parte 4: Criar índices e triggers**
```sql
-- Índices para fornecedores
CREATE INDEX IF NOT EXISTS idx_fornecedores_filial_id ON fornecedores(filial_id);
CREATE INDEX IF NOT EXISTS idx_fornecedores_ativo ON fornecedores(ativo);
CREATE INDEX IF NOT EXISTS idx_fornecedores_nome ON fornecedores(nome);
CREATE INDEX IF NOT EXISTS idx_fornecedores_cnpj ON fornecedores(cnpj) WHERE cnpj IS NOT NULL;

-- Trigger para updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_fornecedores_updated_at 
    BEFORE UPDATE ON fornecedores 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
```

**Parte 5: Configurar RLS (Row Level Security)**
```sql
-- Habilitar RLS
ALTER TABLE fornecedores ENABLE ROW LEVEL SECURITY;

-- Política para usuários autenticados
CREATE POLICY "Usuários podem ver fornecedores de sua filial" ON fornecedores
    FOR SELECT USING (
        filial_id IN (
            SELECT filial_id FROM usuarios WHERE id = auth.uid()
        )
    );

CREATE POLICY "Usuários podem inserir fornecedores em sua filial" ON fornecedores
    FOR INSERT WITH CHECK (
        filial_id IN (
            SELECT filial_id FROM usuarios WHERE id = auth.uid()
        )
    );

CREATE POLICY "Usuários podem atualizar fornecedores de sua filial" ON fornecedores
    FOR UPDATE USING (
        filial_id IN (
            SELECT filial_id FROM usuarios WHERE id = auth.uid()
        )
    );
```

### 3. Validação

Após executar a migração, execute estas consultas para validar:

```sql
-- Verificar se a tabela foi criada
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name = 'fornecedores';

-- Verificar estrutura da tabela
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'fornecedores'
ORDER BY ordinal_position;

-- Verificar índices
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'fornecedores';

-- Verificar triggers
SELECT trigger_name, event_manipulation, action_statement
FROM information_schema.triggers
WHERE event_object_table = 'fornecedores';

-- Verificar políticas RLS
SELECT schemaname, tablename, policyname, cmd, qual
FROM pg_policies
WHERE tablename = 'fornecedores';

-- Teste funcional
INSERT INTO fornecedores (nome, filial_id) 
VALUES ('Fornecedor Teste', 1);

SELECT * FROM fornecedores WHERE nome = 'Fornecedor Teste';

DELETE FROM fornecedores WHERE nome = 'Fornecedor Teste';
```

### 4. Possíveis Erros e Soluções

#### Erro: "relation does not exist"
- **Causa**: Tabela referenciada não existe
- **Solução**: Verificar se todas as tabelas base existem (filiais, cidades, etc.)

#### Erro: "column does not exist"
- **Causa**: Coluna referenciada não existe na estrutura atual
- **Solução**: Verificar o schema atual e ajustar as referências

#### Erro: "permission denied"
- **Causa**: Usuário sem permissões adequadas
- **Solução**: Executar como usuário com privilégios de administrador

### 5. Pós-Migração

1. **Atualizar Types TypeScript**: Copie o conteúdo de `database_types_updated.ts` para seu arquivo de tipos
2. **Testar Interface**: Verifique se as funcionalidades relacionadas a fornecedores funcionam
3. **Backup**: Faça um backup do banco após a migração bem-sucedida

### 6. Rollback (se necessário)

Em caso de problemas, execute:

```sql
-- Remover políticas RLS
DROP POLICY IF EXISTS "Usuários podem ver fornecedores de sua filial" ON fornecedores;
DROP POLICY IF EXISTS "Usuários podem inserir fornecedores em sua filial" ON fornecedores;
DROP POLICY IF EXISTS "Usuários podem atualizar fornecedores de sua filial" ON fornecedores;

-- Remover tabela
DROP TABLE IF EXISTS fornecedores;

-- Restaurar backup (se disponível)
```

## Contato

Em caso de dúvidas ou problemas durante a execução, documente o erro específico para análise.